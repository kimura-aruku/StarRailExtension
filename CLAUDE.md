# CLAUDE.md

このファイルは、このリポジトリでコードを操作する際のClaude Code (claude.ai/code)へのガイダンスを提供します。

## プロジェクト概要

これは崩壊：スターレイルの戦績ページ（https://act.hoyolab.com/app/community-game-records-sea/rpg/index.html）でスコアを計算して表示するChrome拡張機能です。この拡張機能は、一般的に使用されている簡略化された計算式ではなく、正確な計算方式を使用します。

## アーキテクチャ

### ファイル構成
- `manifest.json` - Chrome拡張機能のマニフェスト（v3）
- `content.js` - スコア計算機能を注入するメインのコンテンツスクリプト
- `README.md` - 日本語のプロジェクトドキュメント
- `Images/` - スクリーンショット素材（導入前後の画像）

### 主要コンポーネント

**コンテンツスクリプト (`content.js`)**
- HoyoLab戦績ページでdocument_startで実行される
- MutationObserverを使用してページの変更とキャラクター切り替えを監視
- ユーザーがハイライトした有効サブステータスに基づいてスコアを計算
- 既存のページ構造にスコア表示要素を注入

**スコア計算ロジック**
- 特定の計算式を使用: 会心ダメージ : 会心率 : 攻撃力%（HP%） = 1 : 2 : 1.5
- カスタムサブステータス選択からハイライトされた「有効サブステータス」のみをカウント
- 速度の計算式: (64.8/25.0) * 速度値
- 実数値ステータス（パーセンテージでないHP、攻撃力、防御力）のスコアは0

## 開発コマンド

このプロジェクトはビルドシステムを使用しません。ソースファイルを直接編集して開発します：

1. Chromeでパッケージ化されていない拡張機能を読み込み: `chrome://extensions` → デベロッパーモードを有効 → パッケージ化されていない拡張機能を読み込む
2. 変更後に拡張機能を再読み込み: 拡張機能カードの再読み込みボタンをクリック
3. デバッグ: 対象ページでChrome DevToolsを使用

## 対象ウェブサイト統合

拡張機能は以下のURLでのみ動作します: `https://act.hoyolab.com/app/community-game-records-sea/rpg/index.html*`

### 拡張機能が操作する主要なDOM要素

- `.pc-swiper-block-layout__content` - キャラクター情報コンテナ
- `.c-hrd-ri-name` - キャラクター名要素
- `.c-hrdr-item` - 遺物要素
- `.c-hrdr-btm-item` - 個別ステータス行
- `.c-hrdr-num[highlight="true"]` - ハイライトされた有効サブステータス

## 元のHTML構造

### メインコンテナ
```html
<!-- 【.pc-swiper-block-layout__content】キャラクター選択 + キャラクター詳細  -->
<div class="pc-swiper-block-layout__content">
  <div class="pc-role-detail">
    <!-- キャラクター選択UI -->
    <div class="pc-role-controller">
      <!-- 中略（キャラクター切り替えUI） -->
    </div>
    
    <!-- キャラクター詳細情報 -->
    <div>
      <div class="pc-role-detail-num">
        <!-- 中略（キャラクター詳細 背景） -->

        <!-- キャラクター詳細 左要素 + 右要素 -->
        <div class="pc-rdnp">
          <!-- キャラクター詳細 左要素（キャラ画像、名前、レベル、凸数、光円錐） -->
          <div class="pc-rdnp-left">
            <!-- キャラクター詳細 左要素-キャラ -->
            <div class="c-hrd-ri">
              <!-- 中略（キャラクター詳細 画像） -->
              <div class="c-hrd-ri-info">
                <div class="c-hrd-ri-1">
                  <!-- 【.c-hrd-ri-name】キャラクター名表示（拡張機能の監視対象） -->
                  <div class="c-hrd-ri-name">キャラクター名</div>
                </div>
                <!-- 中略（c-hrd-ri-2～3（属性、運命、凸数）） -->
              </div>
            </div>
            <!-- 中略（キャラクター詳細 左要素-光円錐） -->
          </div>

          <!-- キャラクター詳細 右要素（キャラステータス、遺物） -->
          <div class="pc-rdnp-right">
            <!-- 中略（タイトル、カスタムサブステータスボタン、キャラクターステータス） -->
            <!-- キャラクター詳細 右要素（遺物関連） -->
            <div class="c-hrdrs">
              <div class="c-hrdrs-title">
                <!-- 中略（タイトルラベル） -->
                <!-- 【.c-hrdrs-title-tip】説明文（拡張機能のスタイル参照用） -->
                <div class="c-hrdrs-title-tip">説明文</div>
              </div>
              <!-- 中略（有効サブステータス） -->
              <!-- キャラクター詳細 右要素（遺物x6） -->
              <div class="c-hrdrs-btm">
                <!-- 【.c-hrdr-item】個別遺物要素（拡張機能のスコア計算対象） -->
                <div class="c-hrdr-item">
                  <!-- 中略（タイトル、遺物レベル） -->
                  <!-- 遺物メインステータス + 遺物サブステータス -->
                  <div class="c-hrdr-btm">
                    <!-- メイン/サブステータスの数だけc-hrdr-itemが存在 -->
                    <div class="c-hrdr-btm-item">
                      <!-- 中略（ステータスアイコン） -->
                      <!-- 【.c-hrdcs-name】ステータス名（拡張機能のスタイル参照用） -->
                      <span class="c-hrdr-name">
                      <!-- .c-hrdcs-num】ステータス数値（拡張機能のスタイル参照用） -->
                      <span class="c-hrdr-num">
                    </div>
                    <!-- 中略（残りのc-hrdr-btm-item） -->
                  </div>
                </div>
                <!-- 中略（遺物の数だけc-hrdr-itemが存在） -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
```

### 拡張機能での使用目的

**監視対象要素:**
- `.pc-swiper-block-layout__content` - キャラクター切り替え検知のため監視
- `.c-hrd-ri-name` - キャラクター名変更の検知
- `.pc-role-detail-num` - カスタムサブステータス変更と簡略モード解除の検知

**スコア計算対象要素:**
- `.c-hrdr-item` - 各遺物のスコア計算
- `.c-hrdr-btm-item` - 個別ステータス行（メインステータスとサブステータス）
- `.c-hrdr-name` - ステータス名の取得
- `.c-hrdr-num[highlight="true"]` - ハイライトされた有効サブステータスの数値取得

**スタイル参照用要素:**
- `.c-hrdcs-name` - ラベル用スタイルの参照
- `.c-hrdcs-num` - 数値用スタイルの参照
- `.c-hrdrs-title-tip` - 説明文用スタイルの参照

**スコア表示挿入位置:**
- `.c-hrdrs-btm` の親要素内 - 合計スコア表示の挿入位置
- 各 `.c-hrdr-item` 内 - 個別遺物スコア表示の挿入位置

## 重要な注意事項

- 拡張機能は戦績が「数値」モード（「簡略」モードではない）である必要があります
- カスタムサブステータスパネルからハイライトされたサブステータスのみでスコアを計算します
- 日本語文字列を使用し、現在は日本語のみ対応
- 注入される全ての要素は識別とクリーンアップのためにCSSクラス`alk-element`を使用
- 動的コンテンツの読み込みとユーザー操作を処理するためにmutation observerを使用

## 改善点

以下は現在のコードベースの設計面やパフォーマンス面での改善点です。プロジェクトの更新に応じて、これらの改善点も随時見直しと更新を行ってください。

### 設計面の改善点
- **モジュール化**: 単一の大きな関数内にすべてのロジックが集約されている。スコア計算、DOM操作、監視処理を別々のモジュールに分離することを推奨
- **定数管理**: ハードコードされた値（`MY_CLASS`、セレクター文字列、スコア係数など）を設定オブジェクトまたは定数ファイルに外出しすることを推奨
- **エラーハンドリング**: DOM要素の取得失敗やスタイル取得失敗時の処理が不十分。より詳細なエラーハンドリングと復旧機能の実装を推奨
- **型安全性**: JSDocコメントはあるが、TypeScriptの導入を検討することで型安全性を向上させることができる

### パフォーマンス面の改善点
- **MutationObserver最適化**: 複数のMutationObserverが同じ要素を監視しており、コールバック処理が重複している。観測対象を統合し、処理を最適化することを推奨
- **DOM操作の最適化**: `draw()`関数で毎回全ての要素を削除・再作成している。差分更新やキャッシュ機能の導入を推奨
- **メモリリーク対策**: MutationObserverの適切なクリーンアップが実装されているが、ページ離脱時の明示的なクリーンアップ処理の追加を推奨
- **計算処理の最適化**: スコア計算ロジックで文字列操作と数値変換が毎回実行されている。結果のキャッシュや前処理の導入を推奨

### 保守性の改善点
- **ログ機能の充実**: 現在は簡素なconsole.logのみ。開発・デバッグ用のログレベル管理機能の導入を推奨
- **設定機能**: スコア計算係数や表示設定をユーザーが変更できる機能の追加を推奨
- **テスト機能**: 単体テストやE2Eテストの導入によるコード品質向上を推奨
- **国際化対応**: 現在は日本語のみ対応。多言語対応のための文字列外部化を推奨

### セキュリティ面の改善点
- **CSP対応**: インラインスタイルの使用を最小限に抑え、Content Security Policy対応を強化することを推奨
- **XSS対策**: DOM要素への文字列設定時により厳密なサニタイゼーション処理の導入を推奨

## 開発ガイドライン

### Console ログの使用について

デバッグ用にconsole.logを追加する場合は、HoyoLabのログと区別するために必ず以下の接頭語を使用してください：

```javascript
// 正しい例
console.log('[StarRailExt] デバッグメッセージ');
console.warn('[StarRailExt] 警告メッセージ');
console.error('[StarRailExt] エラーメッセージ');
```

**理由:**
- HoyoLab側のconsole出力と拡張機能のログを明確に分離できる
- Chrome DevToolsのConsoleで`[StarRailExt]`でフィルタリングが可能
- デバッグ作業の効率化とログの可読性向上

**本番環境でのログ:**
- エラーログ（console.error）は残す
- 重要な状態変更のログは残す（言語変更完了など）
- デバッグ用の詳細ログ（DEBUG接頭語付き）は削除する